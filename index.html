<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ø¨Ø§Ø²ÛŒ Ø±ÛŒØ§Ø¶ÛŒ Ú©Ù„Ø§Ø³ Ø§ÙˆÙ„</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="Ø¨Ø§Ø²ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø±ÛŒØ§Ø¶ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù„Ø§Ø³ Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø¨Ø§Ø²ÛŒ Ø±ÛŒØ§Ø¶ÛŒ">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f8ff;
            --primary-color: #4a90e2;
            --secondary-color: #50e3c2;
            --correct-color: #7ed321;
            --wrong-color: #d0021b;
            --text-color: #333;
            --white-color: #ffffff;
            --font-family: 'Vazirmatn', sans-serif;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            width: 95%;
            max-width: 800px;
            background-color: var(--white-color);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
            position: relative;
            height: 90%;
            max-height: 600px;
            display: flex;
            flex-direction: column;
            margin: 20px auto;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-top: 20px;
        }
        
        h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            margin-top: 20px;
        }

        /* Start Screen Styles */
        #start-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        
        #start-screen .menu-button {
            display: block;
            width: 80%;
            margin: 15px auto;
            padding: 20px;
            font-size: 1.5rem;
            font-weight: 700;
            border: none;
            border-radius: 15px;
            color: var(--white-color);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        #start-screen .menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .credits {
            margin-top: 30px;
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 20px;
        }

        /* Game Container Styles */
        #game-container {
            position: static;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        #back-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 100;
        }
        #back-button:hover {
            transform: scale(1.2);
        }

        .game-screen {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- Pattern Game Styles --- */
        #pattern-display {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
            font-size: 4rem;
            align-items: center;
            direction: ltr;
            justify-content: center;
        }
        #pattern-display .placeholder {
            width: 70px;
            height: 70px;
            border: 3px dashed var(--primary-color);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: var(--primary-color);
        }
        #pattern-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .pattern-option {
            font-size: 3.5rem;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: transform 0.2s, background-color 0.2s;
        }
        .pattern-option:hover {
            transform: scale(1.1);
            background-color: rgba(74, 144, 226, 0.1);
        }

        /* --- Sorting Game Styles --- */
        #sorting-game {
            justify-content: flex-start;
            padding: 20px 0;
        }
        #sorting-area {
            display: flex;
            justify-content: space-between;
            width: 100%;
            height: 100%;
            gap: 20px;
            flex-grow: 1;
            margin: 20px 0;
        }
        #items-to-sort {
            border: 2px dashed var(--secondary-color);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 15px;
            width: 48%;
            min-height: 300px;
            padding: 10px;
            border-radius: 15px;
        }
        #drop-zones {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 48%;
        }
        .drop-zone {
            border: 2px solid var(--primary-color);
            background-color: #eef5ff;
            width: 100%;
            min-height: 90px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 5px;
            font-size: 2.5rem;
            font-weight: bold;
            border-radius: 15px;
            flex-grow: 1;
        }
        .drop-zone.over {
            background-color: #d4e7ff;
            border-style: solid;
            transform: scale(1.03);
        }
        .sortable-item {
            font-size: 3rem;
            cursor: grab;
            transition: transform 0.2s;
            touch-action: none; /* Important for touch drag */
        }
        .sortable-item:active {
            cursor: grabbing;
        }
        
        #check-sorting-button {
            margin: 20px auto;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            border: none;
            border-radius: 15px;
            color: var(--white-color);
            background: linear-gradient(45deg, #28a745, #218838);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            flex-shrink: 0;
        }

        /* --- Counting Game Styles --- */
        #fruit-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 10px;
            font-size: 3rem;
            margin: 20px 0;
            min-height: 150px;
            max-width: 90%;
            flex-grow: 1;
        }
        #number-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 325px; /* Fits 5 items perfectly */
            margin: 20px auto;
        }
        .number-option {
            width: 55px;
            height: 55px;
            font-size: 2.2rem;
            font-weight: bold;
            border: 3px solid var(--primary-color);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .number-option:hover {
            background-color: var(--primary-color);
            color: var(--white-color);
            transform: translateY(-5px);
        }

        /* Feedback Styles */
        .correct {
            animation: tada 0.8s;
            background-color: var(--correct-color) !important;
            color: var(--white-color) !important;
            border-color: var(--correct-color) !important;
        }
        .incorrect {
            animation: shake 0.5s;
            background-color: var(--wrong-color) !important;
            color: var(--white-color) !important;
            border-color: var(--wrong-color) !important;
        }
        
        #feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #feedback-modal-content {
            background-color: white;
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            animation: zoomIn 0.5s;
        }
        #feedback-modal-content h2 {
            font-size: 3rem;
            color: var(--correct-color);
            margin: 0;
        }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        @keyframes tada {
            from { transform: scale3d(1, 1, 1); }
            10%, 20% { transform: scale3d(.9, .9, .9) rotate3d(0, 0, 1, -3deg); }
            30%, 50%, 70%, 90% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg); }
            40%, 60%, 80% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg); }
            to { transform: scale3d(1, 1, 1); }
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Mobile Optimization */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                width: 100%;
                height: 100%;
                max-height: 100dvh;
                border-radius: 0;
                padding: 10px;
                box-sizing: border-box;
                justify-content: flex-start;
                overflow-y: hidden;
                margin: 0;
            }
            
            #start-screen {
                justify-content: center;
                padding: 10px;
            }

            h1 { font-size: clamp(1.8rem, 7vw, 2.2rem); margin-top: 10px; }
            h2 { font-size: clamp(1.3rem, 5vw, 1.6rem); margin-top: 20px; margin-bottom: 15px; }

            #start-screen .menu-button {
                padding: 15px;
                font-size: clamp(1rem, 4.5vw, 1.2rem);
                margin: 10px auto;
            }
            
            #back-button {
                top: 5px;
                right: 5px;
            }
            
            .game-screen {
                min-height: 0;
                padding: 30px 10px 10px 10px;
                box-sizing: border-box;
                justify-content: space-between;
            }

            /* Pattern Game Mobile */
            #pattern-display {
                font-size: clamp(2rem, 8vw, 2.5rem);
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
                margin-bottom: 20px;
            }
            #pattern-display .placeholder {
                width: clamp(45px, 12vw, 55px);
                height: clamp(45px, 12vw, 55px);
            }
            #pattern-options {
                gap: 15px;
                margin-bottom: 10px;
            }
            .pattern-option {
                font-size: clamp(2.2rem, 9vw, 2.8rem);
            }
            
            /* Sorting Game Mobile */
            #sorting-area {
                flex-direction: column;
                gap: 10px;
                margin: 10px 0;
            }
            #items-to-sort {
                width: 100%;
                box-sizing: border-box;
                min-height: 100px;
                height: 35%;
                align-content: center;
            }
            #drop-zones {
                width: 100%;
                box-sizing: border-box;
                flex-grow: 1;
                justify-content: space-around;
            }
            .drop-zone {
                font-size: clamp(1.5rem, 6vw, 2rem);
                min-height: 50px;
            }
            .sortable-item {
                font-size: clamp(2rem, 8vw, 2.5rem);
            }
            #check-sorting-button {
                width: 80%;
                margin: 10px auto 0 auto;
            }

            /* Counting Game Mobile */
             #counting-game {
                 justify-content: space-evenly; /* Moves items away from edges */
             }
            #fruit-display {
                font-size: clamp(1.8rem, 7vw, 2.2rem);
                gap: 5px;
                min-height: 120px;
                align-items: center;
                margin: 10px 0;
            }
            #number-options {
                gap: 5px;
                margin: 10px auto;
            }
            .number-option {
                width: clamp(40px, 11vw, 50px);
                height: clamp(40px, 11vw, 50px);
                font-size: clamp(1.5rem, 5vw, 1.8rem);
            }
            
            .credits {
                margin-top: 20px;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- ØµÙØ­Ù‡ Ø´Ø±ÙˆØ¹ -->
        <div id="start-screen">
            <h1>Ø¨Ø§Ø²ÛŒ Ø±ÛŒØ§Ø¶ÛŒ Ú©Ù„Ø§Ø³ Ø§ÙˆÙ„</h1>
            <button class="menu-button" data-game="pattern">Ø¨Ø§Ø²ÛŒ Ø§Ù„Ú¯ÙˆÙ‡Ø§ ğŸ§©</button>
            <button class="menu-button" data-game="sorting">Ø¨Ø§Ø²ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ğŸ¨</button>
            <button class="menu-button" data-game="counting">Ø¨Ø§Ø²ÛŒ Ø´Ù…Ø§Ø±Ø´ ğŸ</button>
            <p class="credits">Ø§ÛŒØ¯Ù‡ Ùˆ ØªÙˆÙ„ÛŒØ¯ ØªÙˆØ³Ø· Ø§Ø­Ø³Ø§Ù† Ø´Ù…Ø³ÛŒ</p>
        </div>

        <!-- Ù…Ø­ÙØ¸Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ -->
        <div id="game-container" class="hidden">
            <button id="back-button">ğŸ </button>

            <!-- Ø¨Ø§Ø²ÛŒ Ø§Ù„Ú¯ÙˆÙ‡Ø§ -->
            <div id="pattern-game" class="game-screen hidden">
                <h2>Ø§Ù„Ú¯Ùˆ Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†</h2>
                <div id="pattern-display"></div>
                <div id="pattern-options"></div>
            </div>

            <!-- Ø¨Ø§Ø²ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ -->
            <div id="sorting-game" class="game-screen hidden">
                 <h2 id="sorting-title"></h2>
                 <div id="sorting-area">
                     <div id="items-to-sort"></div>
                     <div id="drop-zones"></div>
                 </div>
                 <button id="check-sorting-button" class="hidden">Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø®</button>
            </div>

            <!-- Ø¨Ø§Ø²ÛŒ Ø´Ù…Ø§Ø±Ø´ -->
            <div id="counting-game" class="game-screen hidden">
                <h2>Ù…ÛŒÙˆÙ‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø´Ù…Ø§Ø±</h2>
                <div id="fruit-display"></div>
                <div id="number-options"></div>
            </div>

        </div>
    </div>
    
    <div id="feedback-modal" class="hidden">
        <div id="feedback-modal-content">
            <h2>ğŸ‰ Ø¢ÙØ±ÛŒÙ†! ğŸ‰</h2>
        </div>
    </div>

    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // --- Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù„ÛŒ ---
        const startScreen = document.getElementById('start-screen');
        const gameContainer = document.getElementById('game-container');
        const backButton = document.getElementById('back-button');
        const feedbackModal = document.getElementById('feedback-modal');
        
        const patternGameScreen = document.getElementById('pattern-game');
        const sortingGameScreen = document.getElementById('sorting-game');
        const countingGameScreen = document.getElementById('counting-game');
        const gameScreens = [patternGameScreen, sortingGameScreen, countingGameScreen];

        const toPersianNum = num => String(num).replace(/[0-9]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);

        let audioCtx;
        function playSound(type) {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch(e) {
                    console.error("Web Audio API is not supported in this browser");
                }
            }
            if (!audioCtx) return;

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
            } else if (type === 'wrong') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.3);
            }
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.5);
        }

        function showScreen(screen) {
            startScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            gameScreens.forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
        }

        function showStartScreen() {
            gameContainer.classList.add('hidden');
            startScreen.classList.remove('hidden');
        }

        document.querySelectorAll('.menu-button').forEach(button => {
            button.addEventListener('click', () => {
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                const game = button.getAttribute('data-game');
                startGame(game);
            });
        });

        backButton.addEventListener('click', showStartScreen);

        function startGame(gameType) {
            if (gameType === 'pattern') {
                showScreen(patternGameScreen);
                startPatternGame();
            } else if (gameType === 'sorting') {
                showScreen(sortingGameScreen);
                startSortingGame();
            } else if (gameType === 'counting') {
                showScreen(countingGameScreen);
                startCountingGame();
            }
        }
        
        function showFeedbackModal() {
            feedbackModal.classList.remove('hidden');
            setTimeout(() => {
                feedbackModal.classList.add('hidden');
            }, 1500);
        }

        // --- Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ Ø§Ù„Ú¯ÙˆÙ‡Ø§ (Pattern Game) ---
        const patternDisplay = document.getElementById('pattern-display');
        const patternOptions = document.getElementById('pattern-options');
        const patterns = [
            { sequence: ['ğŸ', 'ğŸŒ', 'ğŸ'], answer: 'ğŸŒ', options: ['ğŸŒ', 'ğŸ“', 'ğŸŠ'] },
            { sequence: ['ğŸ”µ', 'ğŸŸ¢', 'ğŸ”µ'], answer: 'ğŸŸ¢', options: ['ğŸŸ¢', 'ğŸ”´', 'ğŸŸ¡'] },
            { sequence: ['â­', 'â¤ï¸', 'â­'], answer: 'â¤ï¸', options: ['â¤ï¸', 'ğŸŒ™', 'â­'] },
            { sequence: ['ğŸš—', 'ğŸš—', 'ğŸš²'], answer: 'ğŸš²', options: ['ğŸš²', 'âœˆï¸', 'ğŸš—'] },
            { sequence: ['â˜€ï¸', 'ğŸŒ™', 'â˜€ï¸'], answer: 'ğŸŒ™', options: ['ğŸŒ™', 'â­', 'â˜ï¸'] },
            { sequence: ['Û±', 'Û²', 'Û±'], answer: 'Û²', options: ['Û²', 'Û³', 'Û±'] },
            { sequence: ['ğŸ¶', 'ğŸ±', 'ğŸ¶'], answer: 'ğŸ±', options: ['ğŸ±', 'ğŸ­', 'ğŸ°'] },
            { sequence: ['ğŸ”º', 'ğŸ”»', 'ğŸ”º'], answer: 'ğŸ”»', options: ['ğŸ”»', 'ğŸŸ¥', 'ğŸ”µ'] },
            { sequence: ['ğŸŸ¥', 'ğŸŸ¥', 'ğŸŸ©'], answer: 'ğŸŸ©', options: ['ğŸŸ©', 'ğŸŸ¥', 'ğŸŸ¦'] },
            { sequence: ['ğŸ‹', 'ğŸ“', 'ğŸ‹'], answer: 'ğŸ“', options: ['ğŸ“', 'ğŸŒ', 'ğŸ‡'] },
            { sequence: ['ğŸŒ', 'ğŸš€', 'ğŸŒ'], answer: 'ğŸš€', options: ['ğŸš€', 'â­', 'âœˆï¸'] },
            { sequence: ['âš«ï¸', 'âšªï¸', 'âš«ï¸'], answer: 'âšªï¸', options: ['âšªï¸', 'âš«ï¸', 'ğŸ”˜'] },
            { sequence: ['â¡ï¸', 'â¬†ï¸', 'â¡ï¸'], answer: 'â¬†ï¸', options: ['â¬†ï¸', 'â¬…ï¸', 'â¬‡ï¸'] },
            { sequence: ['ğŸ°', 'ğŸ¥•', 'ğŸ°'], answer: 'ğŸ¥•', options: ['ğŸ¥•', 'ğŸ¥¬', 'ğŸ°'] },
            { sequence: ['â°', 'ğŸ””', 'â°'], answer: 'ğŸ””', options: ['ğŸ””', 'ğŸ“', 'â³'] },
            { sequence: ['âš½ï¸', 'ğŸ€', 'âš½ï¸'], answer: 'ğŸ€', options: ['ğŸ€', 'ğŸ', 'ğŸˆ'] },
            { sequence: ['ğŸ’§', 'ğŸ”¥', 'ğŸ’§'], answer: 'ğŸ”¥', options: ['ğŸ”¥', 'ğŸŒŠ', 'ğŸ’¨'] },
            { sequence: ['ğŸ”‘', 'ğŸ”’', 'ğŸ”‘'], answer: 'ğŸ”’', options: ['ğŸ”’', 'ğŸ”“', 'ğŸ—ï¸'] },
            { sequence: ['ğŸ™‚', 'ğŸ˜¢', 'ğŸ™‚'], answer: 'ğŸ˜¢', options: ['ğŸ˜¢', 'ğŸ˜„', 'ğŸ˜ '] },
            { sequence: ['ğŸŒ³', 'ğŸŒ³', 'ğŸŒ¸'], answer: 'ğŸŒ¸', options: ['ğŸŒ¸', 'ğŸŒ²', 'ğŸ'] },
            { sequence: ['â›µï¸', 'ğŸš—', 'â›µï¸'], answer: 'ğŸš—', options: ['ğŸš—', 'ğŸš²', 'âœˆï¸'] }
        ];
        let currentPattern;

        function startPatternGame() {
            currentPattern = patterns[Math.floor(Math.random() * patterns.length)];
            patternDisplay.innerHTML = '';
            currentPattern.sequence.forEach(item => {
                patternDisplay.innerHTML += `<span>${item}</span>`;
            });
            patternDisplay.innerHTML += '<span class="placeholder">ØŸ</span>';
            patternOptions.innerHTML = '';
            const shuffledOptions = [...currentPattern.options].sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(option => {
                const optionEl = document.createElement('div');
                optionEl.className = 'pattern-option';
                optionEl.textContent = option;
                optionEl.addEventListener('click', checkPatternAnswer);
                patternOptions.appendChild(optionEl);
            });
        }
        
        function checkPatternAnswer(e) {
            if (e.target.classList.contains('correct') || e.target.classList.contains('incorrect')) return;
            const selectedOption = e.target.textContent;
            if (selectedOption === currentPattern.answer) {
                playSound('correct');
                e.target.classList.add('correct');
                setTimeout(startPatternGame, 1000);
            } else {
                playSound('wrong');
                e.target.classList.add('incorrect');
                setTimeout(() => e.target.classList.remove('incorrect'), 800);
            }
        }

        // --- Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ (Sorting Game) ---
        const itemsToSortContainer = document.getElementById('items-to-sort');
        const dropZonesContainer = document.getElementById('drop-zones');
        const sortingTitle = document.getElementById('sorting-title');
        const checkSortingBtn = document.getElementById('check-sorting-button');
        const sortingScenarios = [
            {
                title: "Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ø±Ø§ Ø¬Ø¯Ø§ Ú©Ù†",
                itemTypes: [ { emoji: 'ğŸ”´', type: 'red' }, { emoji: 'ğŸ”µ', type: 'blue' }, { emoji: 'ğŸŸ¢', type: 'green' } ],
                zones: [ { id: 'red', text: 'ğŸ”´' }, { id: 'blue', text: 'ğŸ”µ' }, { id: 'green', text: 'ğŸŸ¢' } ]
            },
            {
                title: "Ø´Ú©Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ø¬Ø¯Ø§ Ú©Ù†",
                itemTypes: [ { emoji: 'â¤ï¸', type: 'heart' }, { emoji: 'â­', type: 'star' }, { emoji: 'ğŸŒ™', type: 'moon' } ],
                zones: [ { id: 'heart', text: 'â¤ï¸' }, { id: 'star', text: 'â­' }, { id: 'moon', text: 'ğŸŒ™' } ]
            },
            {
                title: "Ø­ÛŒÙˆØ§Ù†Ø§Øª Ùˆ Ù…ÛŒÙˆÙ‡â€ŒÙ‡Ø§",
                itemTypes: [ { emoji: 'ğŸ', type: 'fruit' }, { emoji: 'ğŸ¶', type: 'animal' } ],
                zones: [ { id: 'fruit', text: 'ğŸ' }, { id: 'animal', text: 'ğŸ¾' } ]
            },
            {
                title: "ÙˆØ³Ø§ÛŒÙ„ Ù†Ù‚Ù„ÛŒÙ‡",
                itemTypes: [ { emoji: 'ğŸš—', type: 'land' }, { emoji: 'âœˆï¸', type: 'air' }, { emoji: 'ğŸš¢', type: 'sea' } ],
                zones: [ { id: 'land', text: 'ğŸš—' }, { id: 'air', text: 'âœˆï¸' }, { id: 'sea', text: 'ğŸš¢' } ]
            },
            {
                title: "Ù…ÛŒÙˆÙ‡ Ùˆ Ø³Ø¨Ø²ÛŒØ¬Ø§Øª",
                itemTypes: [ { emoji: 'ğŸ“', type: 'fruit' }, { emoji: 'ğŸ¥•', type: 'veg' }, { emoji: 'ğŸ¥¦', type: 'veg' } ],
                zones: [ { id: 'fruit', text: 'ğŸ“' }, { id: 'veg', text: 'ğŸ¥•' } ]
            },
            {
                title: "Ù‡ÙˆØ§ Ú†Ø·ÙˆØ±Ù‡ØŸ",
                itemTypes: [ { emoji: 'â˜€ï¸', type: 'sun' }, { emoji: 'ğŸŒ§ï¸', type: 'rain' }, { emoji: 'â„ï¸', type: 'snow' } ],
                zones: [ { id: 'sun', text: 'â˜€ï¸' }, { id: 'rain', text: 'ğŸŒ§ï¸' }, { id: 'snow', text: 'â„ï¸' } ]
            },
            {
                title: "Ø§Ø³Ø¨Ø§Ø¨â€ŒØ¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§",
                itemTypes: [ { emoji: 'âš½ï¸', type: 'ball' }, { emoji: 'ğŸš—', type: 'car' }, { emoji: 'ğŸ§¸', type: 'teddy' } ],
                zones: [ { id: 'ball', text: 'âš½ï¸' }, { id: 'car', text: 'ğŸš—' }, { id: 'teddy', text: 'ğŸ§¸' } ]
            },
            {
                title: "Ù„Ø¨Ø§Ø³â€ŒÙ‡Ø§",
                itemTypes: [ { emoji: 'ğŸ‘•', type: 'shirt' }, { emoji: 'ğŸ‘–', type: 'pants' }, { emoji: 'ğŸ‘Ÿ', type: 'shoe' } ],
                zones: [ { id: 'shirt', text: 'ğŸ‘•' }, { id: 'pants', text: 'ğŸ‘–' }, { id: 'shoe', text: 'ğŸ‘Ÿ' } ]
            },
            {
                title: "Ú¯Ø±Ù… Ùˆ Ø³Ø±Ø¯",
                itemTypes: [ { emoji: 'ğŸ”¥', type: 'hot' }, { emoji: 'ğŸ§Š', type: 'cold' } ],
                zones: [ { id: 'hot', text: 'ğŸ”¥' }, { id: 'cold', text: 'ğŸ§Š' } ]
            },
            {
                title: "Ù„ÙˆØ§Ø²Ù… Ù…Ø¯Ø±Ø³Ù‡",
                itemTypes: [ { emoji: 'âœï¸', type: 'pencil' }, { emoji: 'ğŸ“–', type: 'book' }, { emoji: 'âœ‚ï¸', type: 'scissors' } ],
                zones: [ { id: 'pencil', text: 'âœï¸' }, { id: 'book', text: 'ğŸ“–' }, { id: 'scissors', text: 'âœ‚ï¸' } ]
            },
            {
                title: "Ø®ÙˆØ±Ø§Ú©ÛŒâ€ŒÙ‡Ø§",
                itemTypes: [ { emoji: 'ğŸ©', type: 'sweet' }, { emoji: 'ğŸ•', type: 'food' } ],
                zones: [ { id: 'sweet', text: 'ğŸ©' }, { id: 'food', text: 'ğŸ•' } ]
            },
            {
                title: "Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø²Ø±Ø¯ Ùˆ Ø¨Ù†ÙØ´",
                itemTypes: [ { emoji: 'ğŸŸ¡', type: 'yellow' }, { emoji: 'ğŸŸª', type: 'purple' } ],
                zones: [ { id: 'yellow', text: 'ğŸŸ¡' }, { id: 'purple', text: 'ğŸŸª' } ]
            },
            {
                title: "Ú†ÛŒØ²Ù‡Ø§ÛŒ Ú¯Ø±Ø¯ Ùˆ ØªÛŒØ²",
                itemTypes: [ { emoji: 'ğŸ€', type: 'round' }, { emoji: 'ğŸ”º', type: 'sharp' } ],
                zones: [ { id: 'round', text: 'ğŸ€' }, { id: 'sharp', text: 'ğŸ”º' } ]
            }
        ];
        let draggedItem = null;

        function generateSortingItems(itemTypes) {
            const items = [];
            const useSameCount = Math.random() < 0.25;
            let sameCount = 0;
            if (useSameCount) {
                sameCount = Math.floor(Math.random() * 3) + 2;
            }

            itemTypes.forEach(itemType => {
                const count = useSameCount ? sameCount : Math.floor(Math.random() * 3) + 2;
                for (let i = 0; i < count; i++) {
                    items.push({ ...itemType });
                }
            });
            return items;
        }

        function startSortingGame() {
            const scenario = sortingScenarios[Math.floor(Math.random() * sortingScenarios.length)];
            sortingTitle.textContent = scenario.title;
            itemsToSortContainer.innerHTML = '';
            dropZonesContainer.innerHTML = '';
            checkSortingBtn.classList.add('hidden');

            scenario.zones.forEach(zoneData => {
                const zoneEl = document.createElement('div');
                zoneEl.className = 'drop-zone';
                zoneEl.dataset.accepts = zoneData.id;
                zoneEl.innerHTML = `<span>${zoneData.text}</span>`;
                dropZonesContainer.appendChild(zoneEl);
            });

            const itemsToDisplay = generateSortingItems(scenario.itemTypes);
            const shuffledItems = itemsToDisplay.sort(() => Math.random() - 0.5);

            shuffledItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'sortable-item';
                itemEl.textContent = item.emoji;
                itemEl.setAttribute('draggable', true);
                itemEl.dataset.type = item.type;
                itemsToSortContainer.appendChild(itemEl);
            });
            addDragAndDropListeners();
        }

        function addDragAndDropListeners() {
            const items = document.querySelectorAll('.sortable-item');
            const dropZones = document.querySelectorAll('.drop-zone');
            
            items.forEach(item => {
                // Mouse events
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);

                // Touch events
                item.addEventListener('touchstart', handleTouchStart, { passive: false });
                item.addEventListener('touchmove', handleTouchMove, { passive: false });
                item.addEventListener('touchend', handleTouchEnd);
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedItem = this;
            setTimeout(() => { this.style.opacity = '0.5'; }, 0);
        }

        function handleDragEnd() {
            this.style.opacity = '1';
            draggedItem = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            this.classList.add('over');
        }

        function handleDragLeave() {
            this.classList.remove('over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('over');
            if (draggedItem) {
                this.appendChild(draggedItem);
                if (itemsToSortContainer.children.length === 0) {
                    checkSortingBtn.classList.remove('hidden');
                }
            }
        }

        let touchStartX, touchStartY;

        function handleTouchStart(e) {
            draggedItem = this;
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            
            draggedItem.style.transition = 'none'; // Disable transition for smooth dragging
        }

        function handleTouchMove(e) {
            if (!draggedItem) return;
            e.preventDefault(); // Prevent scrolling
            
            const touch = e.touches[0];
            const x = touch.clientX;
            const y = touch.clientY;

            // This part is for visual feedback, but the elementFromPoint is more crucial.
            // For simplicity, we can rely on elementFromPoint without visual clone.
            
            draggedItem.style.visibility = 'hidden'; // Hide original to find what's underneath
            const elementUnder = document.elementFromPoint(x, y);
            draggedItem.style.visibility = 'visible'; // Show it back

            document.querySelectorAll('.drop-zone').forEach(dz => dz.classList.remove('over'));
            
            if (elementUnder) {
                const dropZone = elementUnder.closest('.drop-zone');
                if (dropZone) {
                    dropZone.classList.add('over');
                }
            }
        }

        function handleTouchEnd(e) {
            if (!draggedItem) return;
            
            draggedItem.style.transition = 'transform 0.2s';

            const touch = e.changedTouches[0];
            const x = touch.clientX;
            const y = touch.clientY;

            draggedItem.style.visibility = 'hidden';
            const elementUnder = document.elementFromPoint(x, y);
            draggedItem.style.visibility = 'visible';
            
            document.querySelectorAll('.drop-zone').forEach(dz => dz.classList.remove('over'));
            
            if (elementUnder) {
                const dropZone = elementUnder.closest('.drop-zone');
                if (dropZone) {
                    dropZone.appendChild(draggedItem);
                }
            }

            if (itemsToSortContainer.children.length === 0) {
                checkSortingBtn.classList.remove('hidden');
            }
            draggedItem = null;
        }
        
        function checkSortingAnswers() {
            let allCorrect = true;
            const dropZones = document.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => {
                const acceptedType = zone.dataset.accepts;
                for (let i = zone.children.length - 1; i >= 0; i--) {
                    const child = zone.children[i];
                    if (child.classList.contains('sortable-item')) {
                        if (child.dataset.type !== acceptedType) {
                            allCorrect = false;
                            itemsToSortContainer.appendChild(child);
                        }
                    }
                }
            });

            if (allCorrect && itemsToSortContainer.children.length === 0) {
                playSound('correct');
                showFeedbackModal();
                setTimeout(startSortingGame, 1800);
            } else {
                playSound('wrong');
                checkSortingBtn.classList.add('hidden');
            }
        }
        checkSortingBtn.addEventListener('click', checkSortingAnswers);

        // --- Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ Ø´Ù…Ø§Ø±Ø´ (Counting Game) ---
        const fruitDisplay = document.getElementById('fruit-display');
        const numberOptions = document.getElementById('number-options');
        const fruits = ['ğŸ', 'ğŸŠ', 'ğŸ“', 'ğŸ‡', 'ğŸ¥', 'ğŸ‰', 'ğŸ', 'ğŸ‘'];
        let correctNumber;
        
        function startCountingGame() {
            correctNumber = Math.floor(Math.random() * 10) + 1; // Ø§Ø¹Ø¯Ø§Ø¯ Û± ØªØ§ Û±Û°
            const randomFruit = fruits[Math.floor(Math.random() * fruits.length)];
            fruitDisplay.innerHTML = '';
            for (let i = 0; i < correctNumber; i++) {
                fruitDisplay.innerHTML += `<span>${randomFruit}</span>`;
            }

            numberOptions.innerHTML = '';
            for (let i = 1; i <= 10; i++) { // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ ØªØ§ Û±Û°
                const numberEl = document.createElement('div');
                numberEl.className = 'number-option';
                numberEl.textContent = toPersianNum(i);
                numberEl.dataset.number = i;
                numberEl.addEventListener('click', checkCountingAnswer);
                numberOptions.appendChild(numberEl);
            }
        }

        function checkCountingAnswer(e) {
            if (e.target.classList.contains('correct') || e.target.classList.contains('incorrect')) return;
            const selectedNumber = parseInt(e.target.dataset.number);
            if (selectedNumber === correctNumber) {
                playSound('correct');
                e.target.classList.add('correct');
                 setTimeout(startCountingGame, 1000);
            } else {
                playSound('wrong');
                e.target.classList.add('incorrect');
                setTimeout(() => e.target.classList.remove('incorrect'), 800);
            }
        }

    </script>
</body>
</html>